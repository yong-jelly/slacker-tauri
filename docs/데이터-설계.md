# Slacker 데이터 설계 문서

> 이 문서는 Slacker 앱의 SQLite 기반 데이터 구조와 설계 원칙을 정의합니다.

## 목차

1. [개요](#1-개요)
2. [데이터베이스 스키마](#2-데이터베이스-스키마)
3. [테이블 상세](#3-테이블-상세)
4. [앱 설정](#4-앱-설정)
5. [데이터 흐름](#5-데이터-흐름)
6. [Tauri 커맨드 API](#6-tauri-커맨드-api)

---

## 1. 개요

### 1.1 설계 목표

- **오프라인 우선**: 네트워크 연결 없이 모든 기능 동작
- **단일 파일**: 모든 데이터를 하나의 `.db` 파일로 관리
- **이식성**: 파일 복사만으로 다른 기기에서 사용 가능
- **확장성**: Task 외 추가 기능 확장 용이

### 1.2 파일 구조

```
{app_data_dir}/
├── config.json          # 앱 설정 (DB 경로 등)
└── storage/
    └── slacker.db       # 기본 데이터베이스 파일
```

### 1.3 앱 시작 흐름

```
앱 시작
   │
   ▼
config.json에서 dbPath 로드
   │
   ├── dbPath 없음 또는 파일 없음 → 온보딩 화면
   │
   └── dbPath 있고 파일 존재 → DB 연결 → 마이그레이션 → 메인 화면
```

---

## 2. 데이터베이스 스키마

### 2.1 ERD

```
┌─────────────────┐
│   tbl_setting   │
├─────────────────┤
│ id (PK)         │
│ key (UNIQUE)    │
│ value           │
│ updated_at      │
└─────────────────┘

┌─────────────────┐       ┌──────────────────────┐
│    tbl_task     │───┬──►│    tbl_task_tag      │
├─────────────────┤   │   ├──────────────────────┤
│ id (PK)         │   │   │ id (PK)              │
│ title           │   │   │ task_id (FK)         │
│ description     │   │   │ tag                  │
│ url             │   │   │ created_at           │
│ slack_message_id│   │   └──────────────────────┘
│ priority        │   │
│ status          │   │   ┌──────────────────────┐
│ total_time_spent│   ├──►│   tbl_task_memo      │
│ expected_duration│  │   ├──────────────────────┤
│ target_date     │   │   │ id (PK)              │
│ is_important    │   │   │ task_id (FK)         │
│ created_at      │   │   │ content              │
│ updated_at      │   │   │ created_at           │
│ completed_at    │   │   └──────────────────────┘
│ last_paused_at  │   │
│ last_run_at     │   │   ┌──────────────────────┐
└─────────────────┘   ├──►│   tbl_task_note      │
                      │   ├──────────────────────┤
                      │   │ id (PK)              │
                      │   │ task_id (FK)         │
                      │   │ title                │
                      │   │ content              │
                      │   │ created_at           │
                      │   │ updated_at           │
                      │   └──────────────────────┘
                      │
                      │   ┌──────────────────────────┐
                      ├──►│  tbl_task_run_history    │
                      │   ├──────────────────────────┤
                      │   │ id (PK)                  │
                      │   │ task_id (FK)             │
                      │   │ started_at               │
                      │   │ ended_at                 │
                      │   │ duration                 │
                      │   │ end_type                 │
                      │   └──────────────────────────┘
                      │
                      │   ┌──────────────────────────┐
                      └──►│ tbl_task_time_extension  │
                          ├──────────────────────────┤
                          │ id (PK)                  │
                          │ task_id (FK)             │
                          │ added_minutes            │
                          │ previous_duration        │
                          │ new_duration             │
                          │ reason                   │
                          │ created_at               │
                          └──────────────────────────┘
```

### 2.2 테이블 네이밍 규칙

| 구분 | 규칙 | 예시 |
|------|------|------|
| 테이블 | `tbl_` 접두사 + snake_case | `tbl_task`, `tbl_task_memo` |
| 인덱스 | `idx_` 접두사 + 테이블명_컬럼명 | `idx_task_status` |
| 유니크 인덱스 | `ux_` 접두사 | `ux_task_tag_task_tag` |

---

## 3. 테이블 상세

### 3.1 tbl_setting (앱 설정)

```sql
CREATE TABLE IF NOT EXISTS tbl_setting (
    id TEXT PRIMARY KEY,
    key TEXT UNIQUE NOT NULL,
    value TEXT,
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_setting_key ON tbl_setting(key);
```

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | TEXT (UUID) | Primary Key |
| key | TEXT | 설정 키 (UNIQUE) |
| value | TEXT | 설정 값 (JSON 가능) |
| updated_at | TEXT | 수정 시간 |

### 3.2 tbl_task (Task 메인)

```sql
CREATE TABLE IF NOT EXISTS tbl_task (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    description TEXT,
    url TEXT,
    slack_message_id TEXT,
    priority TEXT NOT NULL DEFAULT 'MEDIUM',
    status TEXT NOT NULL DEFAULT 'INBOX',
    total_time_spent INTEGER NOT NULL DEFAULT 0,
    expected_duration INTEGER DEFAULT 5,
    target_date TEXT,
    is_important INTEGER NOT NULL DEFAULT 0,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),
    completed_at TEXT,
    last_paused_at TEXT,
    last_run_at TEXT
);

CREATE INDEX IF NOT EXISTS idx_task_status ON tbl_task(status);
CREATE INDEX IF NOT EXISTS idx_task_priority ON tbl_task(priority);
CREATE INDEX IF NOT EXISTS idx_task_target_date ON tbl_task(target_date);
CREATE INDEX IF NOT EXISTS idx_task_is_important ON tbl_task(is_important);
```

| 컬럼 | 타입 | 설명 |
|------|------|------|
| id | TEXT (UUID) | Primary Key |
| title | TEXT | Task 제목 |
| description | TEXT | 설명 (선택) |
| url | TEXT | 관련 URL (선택) |
| slack_message_id | TEXT | Slack 메시지 ID (선택) |
| priority | TEXT | 우선순위: LOW, MEDIUM, HIGH |
| status | TEXT | 상태: INBOX, IN_PROGRESS, PAUSED, COMPLETED, ARCHIVED |
| total_time_spent | INTEGER | 총 소요 시간 (분) |
| expected_duration | INTEGER | 예상 작업 시간 (분) |
| target_date | TEXT | 목표 완료일 (ISO 8601) |
| is_important | INTEGER | 중요 표시 (0/1) |
| created_at | TEXT | 생성 시간 |
| updated_at | TEXT | 수정 시간 |
| completed_at | TEXT | 완료 시간 |
| last_paused_at | TEXT | 마지막 일시정지 시간 |
| last_run_at | TEXT | 마지막 실행 시작 시간 |

### 3.3 tbl_task_tag (태그)

```sql
CREATE TABLE IF NOT EXISTS tbl_task_tag (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    tag TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY(task_id) REFERENCES tbl_task(id) ON DELETE CASCADE
);

CREATE UNIQUE INDEX IF NOT EXISTS ux_task_tag_task_tag ON tbl_task_tag(task_id, tag);
CREATE INDEX IF NOT EXISTS idx_task_tag_tag ON tbl_task_tag(tag);
```

### 3.4 tbl_task_memo (짧은 메모)

```sql
CREATE TABLE IF NOT EXISTS tbl_task_memo (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY(task_id) REFERENCES tbl_task(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_task_memo_task_id ON tbl_task_memo(task_id);
```

### 3.5 tbl_task_note (긴 노트)

```sql
CREATE TABLE IF NOT EXISTS tbl_task_note (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    title TEXT NOT NULL,
    content TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY(task_id) REFERENCES tbl_task(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_task_note_task_id ON tbl_task_note(task_id);
```

### 3.6 tbl_task_run_history (실행 히스토리)

```sql
CREATE TABLE IF NOT EXISTS tbl_task_run_history (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    started_at TEXT NOT NULL,
    ended_at TEXT,
    duration INTEGER NOT NULL DEFAULT 0,
    end_type TEXT NOT NULL,
    FOREIGN KEY(task_id) REFERENCES tbl_task(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_task_run_history_task_id ON tbl_task_run_history(task_id);
```

| end_type 값 | 설명 |
|-------------|------|
| completed | 완료 |
| paused | 일시정지 |
| timeout | 타이머 종료 |
| interrupted | 중단 |

### 3.7 tbl_task_time_extension (시간 추가 히스토리)

```sql
CREATE TABLE IF NOT EXISTS tbl_task_time_extension (
    id TEXT PRIMARY KEY,
    task_id TEXT NOT NULL,
    added_minutes INTEGER NOT NULL,
    previous_duration INTEGER NOT NULL,
    new_duration INTEGER NOT NULL,
    reason TEXT,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    FOREIGN KEY(task_id) REFERENCES tbl_task(id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_task_time_extension_task_id ON tbl_task_time_extension(task_id);
```

---

## 4. 앱 설정

### 4.1 설정 키 목록

| 키 | 타입 | 기본값 | 설명 |
|----|------|--------|------|
| `schema_version` | number | 1 | 스키마 버전 |
| `theme` | string | "system" | 테마: light, dark, system |
| `language` | string | "ko" | 언어 코드 |
| `timer_default_minutes` | number | 5 | 타이머 기본 시간 (분) |
| `notification_sound` | boolean | true | 알림 소리 |
| `notification_vibration` | boolean | true | 알림 진동 |

### 4.2 설정 저장 예시

```sql
INSERT OR REPLACE INTO tbl_setting (id, key, value, updated_at)
VALUES (
    'setting_theme',
    'theme',
    '"dark"',
    datetime('now')
);
```

---

## 5. 데이터 흐름

### 5.1 Task CRUD

```
[Create Task]
Frontend → invoke("create_task", {...}) → Rust → INSERT INTO tbl_task → return id

[Read Tasks]
Frontend → invoke("list_tasks", {status?}) → Rust → SELECT + JOINs → return Task[]

[Update Task]
Frontend → invoke("update_task", {id, ...changes}) → Rust → UPDATE tbl_task → return ok

[Delete Task]
Frontend → invoke("delete_task", {id}) → Rust → DELETE (CASCADE) → return ok
```

### 5.2 메모/노트/태그 추가

```
[Add Memo]
Frontend → invoke("add_task_memo", {taskId, content}) → INSERT → return memo

[Add Note]
Frontend → invoke("add_task_note", {taskId, title, content}) → INSERT → return note

[Add Tag]
Frontend → invoke("add_task_tag", {taskId, tag}) → INSERT OR IGNORE → return ok

[Remove Tag]
Frontend → invoke("remove_task_tag", {taskId, tag}) → DELETE → return ok
```

### 5.3 히스토리 기록

```
[Start Run]
Task 시작 시 → invoke("start_task_run", {taskId}) → INSERT run_history → return runId

[End Run]
Task 정지/완료 시 → invoke("end_task_run", {runId, endType}) → UPDATE run_history

[Extend Time]
시간 추가 시 → invoke("extend_task_time", {...}) → INSERT time_extension + UPDATE task
```

---

## 6. Tauri 커맨드 API

### 6.1 DB 관리

| 커맨드 | 파라미터 | 반환 | 설명 |
|--------|----------|------|------|
| `get_db_status` | - | DbStatus | DB 상태 조회 |
| `init_db` | path?: string | DbStatus | 새 DB 초기화 |
| `load_existing_db` | path: string | DbStatus | 기존 DB 로드 |
| `logout` | - | void | DB 연결 해제 |

### 6.2 Task CRUD

| 커맨드 | 파라미터 | 반환 | 설명 |
|--------|----------|------|------|
| `list_tasks` | status?: string | Task[] | Task 목록 조회 |
| `get_task` | id: string | Task | 단건 조회 |
| `create_task` | CreateTaskInput | string | Task 생성 |
| `update_task` | UpdateTaskInput | void | Task 수정 |
| `delete_task` | id: string | void | Task 삭제 |

### 6.3 메모/노트/태그

| 커맨드 | 파라미터 | 반환 | 설명 |
|--------|----------|------|------|
| `add_task_memo` | taskId, content | TaskMemo | 메모 추가 |
| `add_task_note` | taskId, title, content | TaskNote | 노트 추가 |
| `add_task_tag` | taskId, tag | void | 태그 추가 |
| `remove_task_tag` | taskId, tag | void | 태그 제거 |

### 6.4 히스토리

| 커맨드 | 파라미터 | 반환 | 설명 |
|--------|----------|------|------|
| `start_task_run` | taskId | string | 실행 시작 |
| `end_task_run` | runId, endType, duration | void | 실행 종료 |
| `extend_task_time` | ExtendTimeInput | void | 시간 추가 |

### 6.5 설정

| 커맨드 | 파라미터 | 반환 | 설명 |
|--------|----------|------|------|
| `get_setting` | key: string | string? | 설정 조회 |
| `set_setting` | key, value | void | 설정 저장 |
| `get_all_settings` | - | Setting[] | 전체 설정 |

### 6.6 테이블 조회 (고급)

| 커맨드 | 파라미터 | 반환 | 설명 |
|--------|----------|------|------|
| `list_tables` | - | string[] | 테이블 목록 |
| `query_table` | tableName, limit?, offset? | Row[] | 테이블 내용 조회 |

---

## 부록: TypeScript 타입 정의

```typescript
// DB 상태
interface DbStatus {
  configured: boolean;
  path: string;
  exists: boolean;
  sizeBytes?: number;
  tables: string[];
}

// Task 생성 입력
interface CreateTaskInput {
  title: string;
  description?: string;
  url?: string;
  priority?: TaskPriority;
  expectedDuration?: number;
  targetDate?: string;
  tags?: string[];
}

// Task 수정 입력
interface UpdateTaskInput {
  id: string;
  title?: string;
  description?: string;
  url?: string;
  priority?: TaskPriority;
  status?: TaskStatus;
  expectedDuration?: number;
  targetDate?: string;
  isImportant?: boolean;
}

// 시간 추가 입력
interface ExtendTimeInput {
  taskId: string;
  addedMinutes: number;
  previousDuration: number;
  newDuration: number;
  reason?: string;
}
```

